<div class="cms-container">
  <h1>Content Management System</h1>
  
  @if (currentUser(); as user) {
    <div class="user-info">
      <p>Welcome, {{ user.name }} ({{ user.email }})</p>
    </div>
  }

  <!-- Content Creation Form -->
  <mat-card class="create-content-card">
    <mat-card-header>
      <mat-card-title>{{ editingContentId() ? 'Edit Article' : 'Create New Article' }}</mat-card-title>
    </mat-card-header>
    <mat-card-content>
      <form [formGroup]="contentForm" (ngSubmit)="createContent()">
        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Author</mat-label>
          <input matInput formControlName="author" placeholder="Enter author name">
          @if (contentForm.get('author')?.hasError('required')) {
            <mat-error>
              Author is required
            </mat-error>
          }
        </mat-form-field>

        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Title</mat-label>
          <input matInput formControlName="title" placeholder="Enter article title">
          @if (contentForm.get('title')?.hasError('required')) {
            <mat-error>
              Title is required
            </mat-error>
          }
        </mat-form-field>

        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Subtitle</mat-label>
          <input matInput formControlName="subtitle" placeholder="Enter subtitle (optional)">
        </mat-form-field>

        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Content</mat-label>
          <textarea matInput formControlName="content" rows="10" placeholder="Enter content (Markdown supported)"></textarea>
          <mat-hint>Markdown formatting supported: # Headers, **bold**, *italic*, [links](url)</mat-hint>
          @if (contentForm.get('content')?.hasError('required')) {
            <mat-error>
              Content is required
            </mat-error>
          }
        </mat-form-field>

        <!-- Markdown Help Section -->
        <mat-card class="markdown-help">
          <mat-card-content>
            <h4>Markdown Formatting Guide</h4>
            <div class="markdown-examples">
              <div class="example-row">
                <code># Header 1</code>
                <span class="arrow">→</span>
                <span class="result"><strong>Large Header</strong></span>
              </div>
              <div class="example-row">
                <code>## Header 2</code>
                <span class="arrow">→</span>
                <span class="result"><strong>Medium Header</strong></span>
              </div>
              <div class="example-row">
                <code>**bold text**</code>
                <span class="arrow">→</span>
                <span class="result"><strong>bold text</strong></span>
              </div>
              <div class="example-row">
                <code>*italic text*</code>
                <span class="arrow">→</span>
                <span class="result"><em>italic text</em></span>
              </div>
              <div class="example-row">
                <code>[Link text](https://example.com)</code>
                <span class="arrow">→</span>
                <span class="result"><a href="#">Link text</a></span>
              </div>
            </div>
          </mat-card-content>
        </mat-card>

        <div class="form-actions">
          <mat-checkbox formControlName="draft" color="primary">
            Save as Draft
          </mat-checkbox>
          
          <div class="button-group">
            <button mat-raised-button type="button" (click)="resetForm()">
              <mat-icon>clear</mat-icon>
              Clear
            </button>
            <button mat-raised-button color="accent" type="button" [disabled]="!contentForm.valid" (click)="togglePreview()">
              <mat-icon>visibility</mat-icon>
              {{ showPreview() ? 'Hide Preview' : 'Preview' }}
            </button>
            <button mat-raised-button color="primary" type="submit" [disabled]="!contentForm.valid || creating()">
              <mat-icon>{{ contentForm.get('draft')?.value ? 'save' : 'publish' }}</mat-icon>
              {{ editingContentId() ? 'Update' : (contentForm.get('draft')?.value ? 'Save as Draft' : 'Publish') }}
            </button>
          </div>
        </div>
      </form>
    </mat-card-content>
  </mat-card>

  <!-- Preview Section -->
  @if (showPreview()) {
    <mat-card class="preview-card">
      <mat-card-header>
        <mat-card-title>Preview</mat-card-title>
        <button mat-icon-button (click)="togglePreview()">
          <mat-icon>close</mat-icon>
        </button>
      </mat-card-header>
      <mat-card-content>
        <article class="preview-article">
          <h1>{{ contentForm.get('title')?.value }}</h1>
          @if (contentForm.get('subtitle')?.value) {
            <p class="subtitle">{{ contentForm.get('subtitle')?.value }}</p>
          }
          <div class="meta">
            <span><mat-icon>person</mat-icon> {{ contentForm.get('author')?.value }}</span>
            <span><mat-icon>calendar_today</mat-icon> {{ today | date:'mediumDate' }}</span>
          </div>
          <div class="content" [innerHTML]="previewContent()"></div>
        </article>
      </mat-card-content>
    </mat-card>
  }
  
  <div class="content-section">
    <h2>Recent Content</h2>
    
    @if (loading()) {
      <app-loading-spinner message="Loading content..." />
    }
    
    @if (error()) {
      <app-error-display [message]="error()" />
    }
    
    @if (!loading() && !error()) {
      <div class="content-list">
        @for (item of content(); track item.id) {
          <mat-card class="content-item clickable" (click)="editContent(item)">
            <mat-card-header>
              <mat-card-title>{{ item.title }}</mat-card-title>
              <mat-card-subtitle>
                @if (item.draft) {
                  <span class="badge-draft">DRAFT</span>
                }
                @if (!item.draft) {
                  <span class="badge-published">PUBLISHED</span>
                }
              </mat-card-subtitle>
            </mat-card-header>
            <mat-card-content>
              <p class="text-muted">
                <mat-icon>person</mat-icon> {{ item.author }} • 
                <mat-icon>calendar_today</mat-icon> {{ item.createdAt | date:'medium' }}
              </p>
            </mat-card-content>
            <mat-card-actions>
              <button mat-button color="primary" (click)="editContent(item); $event.stopPropagation()">
                <mat-icon>edit</mat-icon>
                Edit
              </button>
            </mat-card-actions>
          </mat-card>
        } @empty {
          <div class="no-content">
            <mat-icon>inbox</mat-icon>
            <p>No content available.</p>
          </div>
        }
      </div>
    }
  </div>
</div>
